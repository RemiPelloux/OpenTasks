<%
const bodyContent = `
<div class="flex flex-col h-[calc(100vh-3.5rem)] overflow-hidden">
  <!-- Header -->
  <div class="flex items-center justify-between px-6 py-4 border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
    <div class="flex items-center gap-4">
      <a href="/project/${project.id}/board" class="inline-flex items-center justify-center rounded-md text-sm font-medium h-9 w-9 hover:bg-accent">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-5 w-5"><path d="m15 18-6-6 6-6"/></svg>
      </a>
      <div>
        <div class="flex items-center gap-2">
          <h1 class="font-semibold">${project.name}</h1>
        </div>
        <p class="text-sm text-muted-foreground">Archived Tickets</p>
      </div>
    </div>
    
    <div class="flex items-center gap-2">
      <a href="/project/${project.id}/board" class="inline-flex items-center justify-center rounded-md text-sm font-medium h-9 px-3 border border-input bg-background hover:bg-accent hover:text-accent-foreground">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4 mr-2"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>
        Back to Board
      </a>
    </div>
  </div>

  <!-- Archive Content -->
  <div class="flex-1 overflow-auto p-6">
    <div class="max-w-4xl mx-auto space-y-4">
      ${tickets.length === 0 ? `
        <div class="flex flex-col items-center justify-center py-16 text-center">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-12 w-12 text-muted-foreground mb-4">
            <rect x="2" y="4" width="20" height="5" rx="2" />
            <path d="M4 9v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9" />
            <path d="M10 13h4" />
          </svg>
          <h3 class="text-lg font-medium text-muted-foreground">No archived tickets</h3>
          <p class="text-sm text-muted-foreground mt-1">Tickets you archive will appear here</p>
        </div>
      ` : `
        <div class="text-sm text-muted-foreground mb-4">
          ${tickets.length} archived ticket${tickets.length !== 1 ? 's' : ''}
        </div>
        
        ${tickets.map(ticket => `
          <div class="archive-ticket flex items-start justify-between p-4 bg-card border rounded-lg hover:border-primary/30 transition-colors" data-ticket-id="${ticket.id}">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${
                  ticket.priority === 'URGENT' ? 'bg-red-500/20 text-red-400' :
                  ticket.priority === 'HIGH' ? 'bg-orange-500/20 text-orange-400' :
                  ticket.priority === 'MEDIUM' ? 'bg-yellow-500/20 text-yellow-400' :
                  'bg-green-500/20 text-green-400'
                }">
                  ${ticket.priority}
                </span>
                <span class="text-xs text-muted-foreground">#${ticket.id.slice(-4)}</span>
              </div>
              <h3 class="font-medium text-sm truncate">${ticket.title}</h3>
              ${ticket.description ? `<p class="text-xs text-muted-foreground mt-1 line-clamp-2">${ticket.description.substring(0, 150)}${ticket.description.length > 150 ? '...' : ''}</p>` : ''}
              <div class="flex items-center gap-4 mt-2 text-xs text-muted-foreground">
                <span class="flex items-center gap-1">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-3 w-3"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                  Archived ${ticket.archivedAt ? new Date(ticket.archivedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A'}
                </span>
                ${ticket.prLink ? `
                  <a href="${ticket.prLink}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-1 text-green-400 hover:underline">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-3 w-3"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
                    View PR
                  </a>
                ` : ''}
              </div>
            </div>
            <div class="flex items-center gap-2 ml-4">
              <button type="button" class="restore-btn inline-flex items-center justify-center rounded-md text-sm font-medium h-8 px-3 border border-input bg-background hover:bg-accent hover:text-accent-foreground" data-ticket-id="${ticket.id}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4 mr-1"><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M21 21v-5h-5"/><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                Restore
              </button>
              <button type="button" class="delete-btn inline-flex items-center justify-center rounded-md text-sm font-medium h-8 px-3 bg-destructive text-destructive-foreground hover:bg-destructive/90" data-ticket-id="${ticket.id}" data-ticket-title="${ticket.title.replace(/"/g, '&quot;')}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="h-4 w-4 mr-1"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                Delete
              </button>
            </div>
          </div>
        `).join('')}
      `}
    </div>
  </div>
</div>

<style>
  .archive-ticket.removing {
    opacity: 0.5;
    transform: translateX(20px);
    transition: all 0.3s ease;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .inline-confirm {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.5rem;
  }
  
  .inline-confirm-btns {
    display: flex;
    gap: 0.5rem;
  }
</style>

<script>
  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';
  const projectId = '${project.id}';

  // Custom confirm function using inline UI
  function showInlineConfirm(btn, message, onConfirm) {
    const container = btn.parentElement;
    const originalButtons = container.innerHTML;
    
    container.innerHTML = \`
      <div class="inline-confirm">
        <span class="text-xs text-muted-foreground">\${message}</span>
        <div class="inline-confirm-btns">
          <button type="button" class="confirm-yes inline-flex items-center justify-center rounded-md text-sm font-medium h-7 px-2 bg-primary text-primary-foreground hover:bg-primary/90">Yes</button>
          <button type="button" class="confirm-no inline-flex items-center justify-center rounded-md text-sm font-medium h-7 px-2 border border-input bg-background hover:bg-accent">No</button>
        </div>
      </div>
    \`;
    
    container.querySelector('.confirm-yes').addEventListener('click', () => {
      container.innerHTML = originalButtons;
      onConfirm();
    });
    
    container.querySelector('.confirm-no').addEventListener('click', () => {
      container.innerHTML = originalButtons;
      // Re-attach event listeners
      attachEventListeners();
    });
  }

  function attachEventListeners() {
    // Restore button handlers
    document.querySelectorAll('.restore-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const ticketId = btn.dataset.ticketId;
        const ticketEl = document.querySelector('.archive-ticket[data-ticket-id="' + ticketId + '"]');
        
        showInlineConfirm(btn, 'Restore to board?', async () => {
          const restoreBtn = document.querySelector('.restore-btn[data-ticket-id="' + ticketId + '"]');
          if (restoreBtn) restoreBtn.disabled = true;
          ticketEl.classList.add('removing');
          
          try {
            const response = await fetch('/api/tickets/' + ticketId + '/restore', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken,
              },
            });
            
            if (!response.ok) {
              const data = await response.json();
              throw new Error(data.error || 'Failed to restore ticket');
            }
            
            // Remove from list with animation
            setTimeout(() => {
              ticketEl.remove();
              window.showToast('Ticket restored to board', 'success');
              
              // Update count or show empty state
              const remaining = document.querySelectorAll('.archive-ticket').length;
              if (remaining === 0) {
                location.reload();
              } else {
                const countEl = document.querySelector('.text-muted-foreground.mb-4');
                if (countEl) {
                  countEl.textContent = remaining + ' archived ticket' + (remaining !== 1 ? 's' : '');
                }
              }
            }, 300);
          } catch (error) {
            ticketEl.classList.remove('removing');
            if (restoreBtn) restoreBtn.disabled = false;
            window.showToast(error.message, 'error');
          }
        });
      });
    });

    // Delete button handlers
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const ticketId = btn.dataset.ticketId;
        const ticketTitle = btn.dataset.ticketTitle;
        const ticketEl = document.querySelector('.archive-ticket[data-ticket-id="' + ticketId + '"]');
        
        showInlineConfirm(btn, 'Delete permanently?', async () => {
          const deleteBtn = document.querySelector('.delete-btn[data-ticket-id="' + ticketId + '"]');
          if (deleteBtn) deleteBtn.disabled = true;
          ticketEl.classList.add('removing');
          
          try {
            const response = await fetch('/api/tickets/' + projectId + '/' + ticketId, {
              method: 'DELETE',
              headers: {
                'X-CSRF-Token': csrfToken,
              },
            });
            
            if (!response.ok) {
              const data = await response.json();
              throw new Error(data.error || 'Failed to delete ticket');
            }
            
            // Remove from list with animation
            setTimeout(() => {
              ticketEl.remove();
              window.showToast('Ticket permanently deleted', 'success');
              
              // Update count or show empty state
              const remaining = document.querySelectorAll('.archive-ticket').length;
              if (remaining === 0) {
                location.reload();
              } else {
                const countEl = document.querySelector('.text-muted-foreground.mb-4');
                if (countEl) {
                  countEl.textContent = remaining + ' archived ticket' + (remaining !== 1 ? 's' : '');
                }
              }
            }, 300);
          } catch (error) {
            ticketEl.classList.remove('removing');
            if (deleteBtn) deleteBtn.disabled = false;
            window.showToast(error.message, 'error');
          }
        });
      });
    });
  }
  
  // Initialize event listeners
  attachEventListeners();
</script>
`;
%>
<%- include('../layout', { body: bodyContent, title, csrfToken, isAuthenticated: true, user, currentPath }) %>
